"use strict";var getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,webrtcMinimumVersion=null,webrtcUtils={log:function(){},extractVersion:function(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}};function trace(e){if("\n"===e[e.length-1]&&(e=e.substring(0,e.length-1)),window.performance){var t=(window.performance.now()/1e3).toFixed(3);webrtcUtils.log(t+": "+e)}else webrtcUtils.log(e)}if("object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return"mozSrcObject"in this?this.mozSrcObject:this._srcObject},set:function(e){"mozSrcObject"in this?this.mozSrcObject=e:(this._srcObject=e,this.src=URL.createObjectURL(e))}}),getUserMedia=window.navigator&&window.navigator.getUserMedia),attachMediaStream=function(e,t){e.srcObject=t},reattachMediaStream=function(e,t){e.srcObject=t.srcObject},"undefined"!=typeof window&&window.navigator)if(navigator.mozGetUserMedia){if(webrtcUtils.log("This appears to be Firefox"),webrtcDetectedBrowser="firefox",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1),webrtcMinimumVersion=31,window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){if(webrtcDetectedVersion<38&&e&&e.iceServers){for(var r=[],n=0;n<e.iceServers.length;n++){var i=e.iceServers[n];if(i.hasOwnProperty("urls"))for(var a=0;a<i.urls.length;a++){var o={url:i.urls[a]};0===i.urls[a].indexOf("turn")&&(o.username=i.username,o.credential=i.credential),r.push(o)}else r.push(e.iceServers[n])}e.iceServers=r}return new mozRTCPeerConnection(e,t)},mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return arguments.length?mozRTCPeerConnection.generateCertificate.apply(null,arguments):mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),getUserMedia=function(e,t,r){var n=function(n){if("object"!=typeof n||n.require)return n;var i=[];return Object.keys(n).forEach(function(e){if("require"!==e&&"advanced"!==e&&"mediaSource"!==e){var t=n[e]="object"==typeof n[e]?n[e]:{ideal:n[e]};if(void 0===t.min&&void 0===t.max&&void 0===t.exact||i.push(e),void 0!==t.exact&&("number"==typeof t.exact?t.min=t.max=t.exact:n[e]=t.exact,delete t.exact),void 0!==t.ideal){n.advanced=n.advanced||[];var r={};"number"==typeof t.ideal?r[e]={min:t.ideal,max:t.ideal}:r[e]=t.ideal,n.advanced.push(r),delete t.ideal,Object.keys(t).length||delete n[e]}}}),i.length&&(n.require=i),n};return webrtcDetectedVersion<38&&(webrtcUtils.log("spec: "+JSON.stringify(e)),e.audio&&(e.audio=n(e.audio)),e.video&&(e.video=n(e.video)),webrtcUtils.log("ff37: "+JSON.stringify(e))),navigator.mozGetUserMedia(e,t,r)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}])})},webrtcDetectedVersion<41){var orgEnumerateDevices=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return orgEnumerateDevices().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}}else if(navigator.webkitGetUserMedia&&window.webkitRTCPeerConnection){webrtcUtils.log("This appears to be Chrome"),webrtcDetectedBrowser="chrome",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2),webrtcMinimumVersion=38,window.RTCPeerConnection=function(e,t){e&&e.iceTransportPolicy&&(e.iceTransports=e.iceTransportPolicy);var r=new webkitRTCPeerConnection(e,t),o=r.getStats.bind(r);return r.getStats=function(r,e,t){var n=this,i=arguments;if(0<arguments.length&&"function"==typeof r)return o(r,e);var a=function(e){var n={};return e.result().forEach(function(t){var r={id:t.id,timestamp:t.timestamp,type:t.type};t.names().forEach(function(e){r[e]=t.stat(e)}),n[r.id]=r}),n};if(2<=arguments.length){return o.apply(this,[function(e){i[1](a(e))},r])}return new Promise(function(t,e){1===i.length&&null===r?o.apply(n,[function(e){t.apply(null,[a(e)])},e]):o.apply(n,[t,e])})},r},webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return arguments.length?webkitRTCPeerConnection.generateCertificate.apply(null,arguments):webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(e){var i=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var r=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var n=1===arguments.length?arguments[0]:void 0;return new Promise(function(e,t){i.apply(r,[e,t,n])})}return i.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var i=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var r=arguments,n=this;return new Promise(function(e,t){i.apply(n,[r[0],function(){e(),2<=r.length&&r[1].apply(null,[])},function(e){t(e),3<=r.length&&r[2].apply(null,[e])}])})}});var constraintsToChrome=function(i){if("object"!=typeof i||i.mandatory||i.optional)return i;var a={};return Object.keys(i).forEach(function(t){if("require"!==t&&"advanced"!==t&&"mediaSource"!==t){var r="object"==typeof i[t]?i[t]:{ideal:i[t]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){a.optional=a.optional||[];var e={};"number"==typeof r.ideal?(e[n("min",t)]=r.ideal,a.optional.push(e),(e={})[n("max",t)]=r.ideal):e[n("",t)]=r.ideal,a.optional.push(e)}void 0!==r.exact&&"number"!=typeof r.exact?(a.mandatory=a.mandatory||{},a.mandatory[n("",t)]=r.exact):["min","max"].forEach(function(e){void 0!==r[e]&&(a.mandatory=a.mandatory||{},a.mandatory[n(e,t)]=r[e])})}}),i.advanced&&(a.optional=(a.optional||[]).concat(i.advanced)),a};if(getUserMedia=function(e,t,r){return e.audio&&(e.audio=constraintsToChrome(e.audio)),e.video&&(e.video=constraintsToChrome(e.video)),webrtcUtils.log("chrome: "+JSON.stringify(e)),navigator.webkitGetUserMedia(e,t,r)},navigator.getUserMedia=getUserMedia,navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:requestUserMedia,enumerateDevices:function(){return new Promise(function(t){var r={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(e){t(e.map(function(e){return{label:e.label,kind:r[e.kind],deviceId:e.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var origGetUserMedia=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(e){return webrtcUtils.log("spec:   "+JSON.stringify(e)),e.audio=constraintsToChrome(e.audio),e.video=constraintsToChrome(e.video),webrtcUtils.log("chrome: "+JSON.stringify(e)),origGetUserMedia(e)}}else navigator.mediaDevices.getUserMedia=function(e){return requestUserMedia(e)};void 0===navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){webrtcUtils.log("Dummy mediaDevices.addEventListener called.")}),void 0===navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){webrtcUtils.log("Dummy mediaDevices.removeEventListener called.")}),attachMediaStream=function(e,t){43<=webrtcDetectedVersion?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):webrtcUtils.log("Error attaching stream to element.")},reattachMediaStream=function(e,t){43<=webrtcDetectedVersion?e.srcObject=t.srcObject:e.src=t.src}}else if(navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)){if(webrtcUtils.log("This appears to be Edge"),webrtcDetectedBrowser="edge",webrtcDetectedVersion=webrtcUtils.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2),webrtcMinimumVersion=10547,window.RTCIceGatherer){var generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},localCName=generateIdentifier(),SDPUtils={splitLines:function(e){return e.trim().split("\n").map(function(e){return e.trim()})},splitSections:function(e){return e.split("\r\nm=").map(function(e,t){return(0<t?"m="+e:e).trim()+"\r\n"})},matchPrefix:function(e,t){return SDPUtils.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},parseCandidate:function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1]}return r},writeCandidate:function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),"candidate:"+t.join(" ")},parseRtpMap:function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.numChannels=3===t.length?parseInt(t[2],10):1,r},writeRtpMap:function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},parseFmtp:function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<n.length;i++)r[(t=n[i].trim().split("="))[0].trim()]=t[1];return r},writeFtmp:function(t){var e="",r=t.payloadType;if(void 0!==t.preferredPayloadType&&(r=t.preferredPayloadType),t.parameters&&t.parameters.length){var n=[];Object.keys(t.parameters).forEach(function(e){n.push(e+"="+t.parameters[e])}),e+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return e},parseRtcpFb:function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},writeRtcpFb:function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+r+" "+e.type+" "+e.parameter+"\r\n"}),t},parseSsrcMedia:function(e){var t=e.indexOf(" "),r={ssrc:e.substr(7,t-7)},n=e.indexOf(":",t);return-1<n?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},getDtlsParameters:function(e,t){var r=SDPUtils.splitLines(e),n=(r=r.concat(SDPUtils.splitLines(t))).filter(function(e){return 0===e.indexOf("a=fingerprint:")})[0].substr(14);return{role:"auto",fingerprints:[{algorithm:n.split(" ")[0],value:n.split(" ")[1]}]}},writeDtlsParameters:function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),r},getIceParameters:function(e,t){var r=SDPUtils.splitLines(e);return{usernameFragment:(r=r.concat(SDPUtils.splitLines(t))).filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:r.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)}},writeIceParameters:function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},parseRtpParameters:function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=SDPUtils.splitLines(e)[0].split(" "),n=3;n<r.length;n++){var i=r[n],a=SDPUtils.matchPrefix(e,"a=rtpmap:"+i+" ")[0];if(a){var o=SDPUtils.parseRtpMap(a),s=SDPUtils.matchPrefix(e,"a=fmtp:"+i+" ");o.parameters=s.length?SDPUtils.parseFmtp(s[0]):{},o.rtcpFeedback=SDPUtils.matchPrefix(e,"a=rtcp-fb:"+i+" ").map(SDPUtils.parseRtcpFb),t.codecs.push(o)}}return t},writeRtpDescription:function(e,t){var r="";return r+="m="+e+" ",r+=0<t.codecs.length?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){r+=SDPUtils.writeRtpMap(e),r+=SDPUtils.writeFtmp(e),r+=SDPUtils.writeRtcpFb(e)}),r+="a=rtcp-mux\r\n"},writeSessionBoilerplate:function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},writeMediaSection:function(e,t,r,n){var i=SDPUtils.writeRtpDescription(e.kind,t);if(i+=SDPUtils.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=SDPUtils.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),i+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?i+="a=sendrecv\r\n":e.rtpSender?i+="a=sendonly\r\n":e.rtpReceiver?i+="a=recvonly\r\n":i+="a=inactive\r\n",e.rtpSender){var a="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";i+="a="+a,i+="a=ssrc:"+e.sendSsrc+" "+a}return i+="a=ssrc:"+e.sendSsrc+" cname:"+localCName+"\r\n"},getDirection:function(e,t){for(var r=SDPUtils.splitLines(e),n=0;n<r.length;n++)switch(r[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[n].substr(2)}return t?SDPUtils.getDirection(t):"sendrecv"}};window.RTCIceCandidate||(window.RTCIceCandidate=function(e){return e}),window.RTCSessionDescription||(window.RTCSessionDescription=function(e){return e}),window.RTCPeerConnection=function(e){var r=this;if(this.onicecandidate=null,this.onaddstream=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return r.localStreams},this.getRemoteStreams=function(){return r.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},e&&e.iceTransportPolicy)switch(e.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=e.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}e&&e.iceServers&&e.iceServers.forEach(function(e){var t;e.urls&&(-1!==(t="string"==typeof e.urls?e.urls:e.urls[0]).indexOf("transport=udp")&&r.iceServers.push({username:e.username,credential:e.credential,urls:t}))}),this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var t=this;this._localIceCandidatesBuffer.forEach(function(e){null!==t.onicecandidate&&t.onicecandidate(e)}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.addStream=function(e){this.localStreams.push(e.clone()),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);-1<t&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype._getCommonCapabilities=function(e,n){var i={codecs:[],headerExtensions:[],fecMechanisms:[]};return e.codecs.forEach(function(e){for(var t=0;t<n.codecs.length;t++){var r=n.codecs[t];if(e.name.toLowerCase()===r.name.toLowerCase()&&e.clockRate===r.clockRate&&e.numChannels===r.numChannels){i.codecs.push(r);break}}}),e.headerExtensions.forEach(function(e){for(var t=0;t<n.headerExtensions.length;t++){var r=n.headerExtensions[t];if(e.uri===r.uri){i.headerExtensions.push(r);break}}}),i},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(i,a){var o=this,s=new RTCIceGatherer(o.iceOptions),c=new RTCIceTransport(s);s.onlocalcandidate=function(e){var t={};t.candidate={sdpMid:i,sdpMLineIndex:a};var r=e.candidate;r&&0!==Object.keys(r).length?(r.component="RTCP"===c.component?2:1,t.candidate.candidate=SDPUtils.writeCandidate(r)):(void 0===s.state&&(s.state="completed"),t.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates");var n=o.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});null!==o.onicecandidate&&(o.localDescription&&""===o.localDescription.type?(o._localIceCandidatesBuffer.push(t),n&&o._localIceCandidatesBuffer.push({})):(o.onicecandidate(t),n&&o.onicecandidate({})))},c.onicestatechange=function(){o._updateConnectionState()};var e=new RTCDtlsTransport(c);return e.ondtlsstatechange=function(){o._updateConnectionState()},e.onerror=function(){e.state="failed",o._updateConnectionState()},{iceGatherer:s,iceTransport:c,dtlsTransport:e}},window.RTCPeerConnection.prototype._transceive=function(e,t,r){var n=this._getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(n.encodings=[{ssrc:e.sendSsrc}],n.rtcp={cname:localCName,ssrc:e.recvSsrc},e.rtpSender.send(n)),r&&e.rtpReceiver&&(n.encodings=[{ssrc:e.recvSsrc}],n.rtcp={cname:e.cname,ssrc:e.sendSsrc},e.rtpReceiver.receive(n))},window.RTCPeerConnection.prototype.setLocalDescription=function(e){var p=this;if("offer"===e.type)this._pendingOffer&&(this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===e.type){var t=SDPUtils.splitSections(p.remoteDescription.sdp),u=t.shift();t.forEach(function(e,t){var r=p.transceivers[t],n=r.iceGatherer,i=r.iceTransport,a=r.dtlsTransport,o=r.localCapabilities,s=r.remoteCapabilities;if(!("0"===e.split("\n",1)[0].split(" ",2)[1])){var c=SDPUtils.getIceParameters(e,u);i.start(n,c,"controlled");var d=SDPUtils.getDtlsParameters(e,u);a.start(d);var l=p._getCommonCapabilities(o,s);p._transceive(r,0<l.codecs.length,!1)}})}switch((this.localDescription=e).type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}var r=1<arguments.length&&"function"==typeof arguments[1];if(r){var n=arguments[1];window.setTimeout(function(){n(),p._emitBufferedCandidates()},0)}var i=Promise.resolve();return i.then(function(){r||window.setTimeout(p._emitBufferedCandidates.bind(p),0)}),i},window.RTCPeerConnection.prototype.setRemoteDescription=function(y){var P=this,D=new MediaStream,e=SDPUtils.splitSections(y.sdp),R=e.shift();switch(e.forEach(function(e,t){var r,n,i,a,o,s,c,d,l,p,u,f=SDPUtils.splitLines(e)[0].substr(2).split(" "),m=f[0],v="0"===f[1],h=SDPUtils.getDirection(e,R),w=SDPUtils.parseRtpParameters(e);v||(p=SDPUtils.getIceParameters(e,R),u=SDPUtils.getDtlsParameters(e,R));var g,C=SDPUtils.matchPrefix(e,"a=mid:")[0].substr(6),b=SDPUtils.matchPrefix(e,"a=ssrc:").map(function(e){return SDPUtils.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];if(b&&(d=parseInt(b.ssrc,10),g=b.value),"offer"===y.type){var T=P._createIceAndDtlsTransports(C,t);if(l=RTCRtpReceiver.getCapabilities(m),c=1001*(2*t+2),s=new RTCRtpReceiver(T.dtlsTransport,m),D.addTrack(s.track),0<P.localStreams.length&&P.localStreams[0].getTracks().length>=t){var S=P.localStreams[0].getTracks()[t];o=new RTCRtpSender(S,T.dtlsTransport)}P.transceivers[t]={iceGatherer:T.iceGatherer,iceTransport:T.iceTransport,dtlsTransport:T.dtlsTransport,localCapabilities:l,remoteCapabilities:w,rtpSender:o,rtpReceiver:s,kind:m,mid:C,cname:g,sendSsrc:c,recvSsrc:d},P._transceive(P.transceivers[t],!1,"sendrecv"===h||"sendonly"===h)}else"answer"!==y.type||v||(n=(r=P.transceivers[t]).iceGatherer,i=r.iceTransport,a=r.dtlsTransport,o=r.rtpSender,s=r.rtpReceiver,c=r.sendSsrc,l=r.localCapabilities,P.transceivers[t].recvSsrc=d,P.transceivers[t].remoteCapabilities=w,P.transceivers[t].cname=g,i.start(n,p,"controlling"),a.start(u),P._transceive(r,"sendrecv"===h||"recvonly"===h,"sendrecv"===h||"sendonly"===h),!s||"sendrecv"!==h&&"sendonly"!==h?delete r.rtpReceiver:D.addTrack(s.track))}),(this.remoteDescription=y).type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+y.type+'"')}return window.setTimeout(function(){null!==P.onaddstream&&D.getTracks().length&&(P.remoteStreams.push(D),window.setTimeout(function(){P.onaddstream({stream:D})},0))},0),1<arguments.length&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(e){this.signalingState=e,null!==this.onsignalingstatechange&&this.onsignalingstatechange()},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){null!==this.onnegotiationneeded&&this.onnegotiationneeded()},window.RTCPeerConnection.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};this.transceivers.forEach(function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++}),t.connected+=t.completed,e="new",0<t.failed?e="failed":0<t.connecting||0<t.checking?e="connecting":0<t.disconnected?e="disconnected":0<t.new?e="new":(0<t.connecting||0<t.completed)&&(e="connected"),e!==this.iceConnectionState&&(this.iceConnectionState=e,null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange())},window.RTCPeerConnection.prototype.createOffer=function(){var e,p=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");1===arguments.length&&"function"!=typeof arguments[0]?e=arguments[0]:3===arguments.length&&(e=arguments[2]);var t=[],r=0,n=0;if(this.localStreams.length&&(r=this.localStreams[0].getAudioTracks().length,n=this.localStreams[0].getVideoTracks().length),e){if(e.mandatory||e.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==e.offerToReceiveAudio&&(r=e.offerToReceiveAudio),void 0!==e.offerToReceiveVideo&&(n=e.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(e){t.push({kind:e.kind,track:e,wantReceive:"audio"===e.kind?0<r:0<n}),"audio"===e.kind?r--:"video"===e.kind&&n--});0<r||0<n;)0<r&&(t.push({kind:"audio",wantReceive:!0}),r--),0<n&&(t.push({kind:"video",wantReceive:!0}),n--);var u=SDPUtils.writeSessionBoilerplate(),f=[];t.forEach(function(e,t){var r,n,i=e.track,a=e.kind,o=generateIdentifier(),s=p._createIceAndDtlsTransports(o,t),c=RTCRtpSender.getCapabilities(a),d=1001*(2*t+1);i&&(r=new RTCRtpSender(i,s.dtlsTransport)),e.wantReceive&&(n=new RTCRtpReceiver(s.dtlsTransport,a)),f[t]={iceGatherer:s.iceGatherer,iceTransport:s.iceTransport,dtlsTransport:s.dtlsTransport,localCapabilities:c,remoteCapabilities:null,rtpSender:r,rtpReceiver:n,kind:a,mid:o,sendSsrc:d,recvSsrc:null};var l=f[t];u+=SDPUtils.writeMediaSection(l,l.localCapabilities,"offer",p.localStreams[0])}),this._pendingOffer=f;var i=new RTCSessionDescription({type:"offer",sdp:u});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,i),Promise.resolve(i)},window.RTCPeerConnection.prototype.createAnswer=function(){var r=this;1===arguments.length&&"function"!=typeof arguments[0]?arguments[0]:3===arguments.length&&arguments[2];var n=SDPUtils.writeSessionBoilerplate();this.transceivers.forEach(function(e){var t=r._getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);n+=SDPUtils.writeMediaSection(e,t,"answer",r.localStreams[0])});var e=new RTCSessionDescription({type:"answer",sdp:n});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,e),Promise.resolve(e)},window.RTCPeerConnection.prototype.addIceCandidate=function(e){var t=e.sdpMLineIndex;if(e.sdpMid)for(var r=0;r<this.transceivers.length;r++)if(this.transceivers[r].mid===e.sdpMid){t=r;break}var n=this.transceivers[t];if(n){var i=0<Object.keys(e.candidate).length?SDPUtils.parseCandidate(e.candidate):{};if("tcp"===i.protocol&&0===i.port)return;if("1"!==i.component)return;"endOfCandidates"===i.type&&(i={}),n.iceTransport.addRemoteCandidate(i)}return 1<arguments.length&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var n=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(e){t[e]&&n.push(t[e].getStats())})});var i=1<arguments.length&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(t){var r={};Promise.all(n).then(function(e){e.forEach(function(t){Object.keys(t).forEach(function(e){r[e]=t[e]})}),i&&window.setTimeout(i,0,r),t(r)})})}}}else webrtcUtils.log("Browser does not appear to be WebRTC-capable");else webrtcUtils.log("This does not appear to be a browser"),webrtcDetectedBrowser="not a browser";function requestUserMedia(r){return new Promise(function(e,t){getUserMedia(r,e,t)})}var RTCPeerConnection,RTCIceCandidate,RTCSessionDescription,webrtcTesting={};try{Object.defineProperty(webrtcTesting,"version",{set:function(e){webrtcDetectedVersion=e}})}catch(e){}"undefined"!=typeof module?("undefined"!=typeof window&&(RTCPeerConnection=window.RTCPeerConnection,RTCIceCandidate=window.RTCIceCandidate,RTCSessionDescription=window.RTCSessionDescription),module.exports={RTCPeerConnection:RTCPeerConnection,RTCIceCandidate:RTCIceCandidate,RTCSessionDescription:RTCSessionDescription,getUserMedia:getUserMedia,attachMediaStream:attachMediaStream,reattachMediaStream:reattachMediaStream,webrtcDetectedBrowser:webrtcDetectedBrowser,webrtcDetectedVersion:webrtcDetectedVersion,webrtcMinimumVersion:webrtcMinimumVersion,webrtcTesting:webrtcTesting,webrtcUtils:webrtcUtils}):"function"==typeof require&&"function"==typeof define&&define([],function(){return{RTCPeerConnection:window.RTCPeerConnection,RTCIceCandidate:window.RTCIceCandidate,RTCSessionDescription:window.RTCSessionDescription,getUserMedia:getUserMedia,attachMediaStream:attachMediaStream,reattachMediaStream:reattachMediaStream,webrtcDetectedBrowser:webrtcDetectedBrowser,webrtcDetectedVersion:webrtcDetectedVersion,webrtcMinimumVersion:webrtcMinimumVersion,webrtcTesting:webrtcTesting,webrtcUtils:webrtcUtils}});