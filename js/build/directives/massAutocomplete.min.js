!function(){"use strict";angular.module("MassAutoComplete",[]).provider("massAutocompleteConfig",function(){var e=this;e.KEYS={ESC:27,ENTER:13,UP:38,DOWN:40},e.EVENTS={KEYDOWN:"keydown",RESIZE:"resize",BLUR:"blur"},e.DEBOUNCE={position:150,attach:300,suggest:200,blur:150},e.generate_random_id=function(e){return e+"_"+Math.random().toString().substring(2)},e.position_autocomplete=function(e,t){var n=t[0].getBoundingClientRect(),o=document.body.scrollTop||document.documentElement.scrollTop||window.pageYOffset,i=document.body.scrollLeft||document.documentElement.scrollLeft||window.pageXOffset;e[0].style.top=n.top+n.height+o+"px",e[0].style.left=n.left+i+"px",e[0].style.width=n.width+"px"},this.$get=function(){return e}}).directive("massAutocomplete",["massAutocompleteConfig","$timeout","$window","$document","$q",function(V,x,D,A,o){return{restrict:"A",scope:{options:"&massAutocomplete"},transclude:!0,template:'<span ng-transclude></span><div class="ac-container" aria-autocomplete="list" role="listbox" ng-show="show_autocomplete" style="position:absolute;"><ul class="ac-menu"> <li ng-repeat="result in results" ng-if="$index > 0" class="ac-menu-item" role="option" id="{{result.id}}" ng-class="$index == selected_index ? \'ac-state-focus\': \'\'"><a href ng-click="apply_selection($index)" ng-bind-html="result.label"></a></li></ul></div>',link:function(e,t){e.container=angular.element(t[0].getElementsByClassName("ac-container")[0])},controller:["$scope",function(u){var r=this,d={};d[V.EVENTS.BLUR]=null,d[V.EVENTS.KEYDOWN]=null,d[V.EVENTS.RESIZE]=null;var p,E,m,f,_,g,h,b,e=u.options()||{},v={debounce_position:e.debounce_position||V.DEBOUNCE.position,debounce_attach:e.debounce_attach||V.DEBOUNCE.attach,debounce_suggest:e.debounce_suggest||V.DEBOUNCE.suggest,debounce_blur:e.debounce_blur||V.DEBOUNCE.blur};function N(){u.show_autocomplete=!0}function w(){u.show_autocomplete=!1,u.selected_index=-1,u.container[0].removeAttribute("aria-activedescendant")}function t(o,i,a){var l;return function(){var e=this,t=arguments,n=a&&!l;x.cancel(l),l=x(function(){l=null,a||o.apply(e,t)},i),n&&o.apply(e,t)}}function y(){V.position_autocomplete(u.container,p)}u.show_autocomplete=!1;var S=t(y,v.debounce_position);var T=t(function(t,n){u.selected_index=0,u.waiting_for_suggestion=!0,"string"==typeof t&&0<t.length?o.when(f.suggest(t,E),function(e){p&&p===n&&(e&&0<e.length?(e.forEach(function(e){e.id||(e.id=V.generate_random_id("ac_item"))}),u.results=[{value:t,label:"",id:""}].concat(e),N(),f.auto_select_first&&$(1)):(u.results=[],w()))},function(e){w(),f.on_error&&f.on_error(e)}).finally(function(){u.waiting_for_suggestion=!1}):(u.waiting_for_suggestion=!1,w(),u.$apply())},v.debounce_suggest);function n(e){if(m.$modelValue!==e){m.$setViewValue(e),m.$render();var t=p[0].attributes["ng-model"].value;u.$parent[t]=e}}function $(e){var t=u.results[e];return p.val(t.value),u.selected_index=e,u.container[0].setAttribute("aria-activedescendant",t.id),t}r.attach=t(function(e,t,n,o,i,a,l){if(p!==t&&(p&&r.detach(),t[0]===A[0].activeElement)){var s,c={Items:o,KeyText:i,LinkType:a,Delimiter:l};n.on_attach&&n.on_attach(c),p=t,E=l,f=n,_=(m=e).$viewValue,b=!((s=t).id&&""!==s.id||(s.id=V.generate_random_id("ac_element"),0)),u.container[0].setAttribute("aria-labelledby",p.id),u.results=[],u.selected_index=-1,angular.element(D).bind(V.EVENTS.RESIZE,S),d[V.EVENTS.BLUR]=function(){x(function(){p&&p[0]===A[0].activeElement||r.detach()},v.debounce_blur)},p.bind(V.EVENTS.BLUR,d[V.EVENTS.BLUR]),d[V.EVENTS.KEYDOWN]=function(e){if(!e.shiftKey)switch(e.keyCode){case V.KEYS.ESC:u.show_autocomplete?(w(),u.$apply()):p.val(_);break;case V.KEYS.ENTER:u.show_autocomplete&&0<u.selected_index&&!u.waiting_for_suggestion&&(u.apply_selection(u.selected_index),e.stopPropagation(),e.preventDefault()),w(),u.$apply();break;case V.KEYS.TAB:if(!u.show_autocomplete)break;e.preventDefault();case V.KEYS.DOWN:0<u.results.length&&(u.show_autocomplete?$(u.selected_index+1>u.results.length-1?0:u.selected_index+1):(N(),$(0)),u.$apply());break;case V.KEYS.UP:u.show_autocomplete&&(e.preventDefault(),$(0<=u.selected_index-1?u.selected_index-1:u.results.length-1),u.$apply())}},p.bind(V.EVENTS.KEYDOWN,d[V.EVENTS.KEYDOWN]),g=u.$watch(function(){return e.$modelValue},function(e){e!==h&&(y(),T(e,p))})}},v.debounce_attach),r.detach=function(){if(p){var e=p.val();n(e),f.on_detach&&f.on_detach(e),p.unbind(V.EVENTS.KEYDOWN,d[V.EVENTS.KEYDOWN]),p.unbind(V.EVENTS.BLUR,d[V.EVENTS.BLUR]),b&&p[0].removeAttribute("id")}w(),u.container[0].removeAttribute("aria-labelledby"),angular.element(D).unbind(V.EVENTS.RESIZE,d[V.EVENTS.RESIZE]),g&&g(),u.selected_index=u.results=void 0,m=p=_=void 0},u.apply_selection=function(e){if(p[0].focus(),!(!u.show_autocomplete||e>u.results.length||e<0)){var t=$(e);h=t.value,n(t.value),w(),f.on_select&&f.on_select(t)}},u.$on("$destroy",function(){r.detach(),u.container.remove()})}]}}]).directive("massAutocompleteItem",function(){return{restrict:"A",require:["^massAutocomplete","ngModel"],scope:{massAutocompleteItem:"&",uiItems:"=",uiKey:"@",uiLinkType:"@",uiDelimiter:"@"},link:function(t,n,e,o){e.$set("autocomplete","off");var i=o[0],a=o[1];n.bind("focus",function(){var e=t.massAutocompleteItem();if(!e)throw new Error("Invalid options");i.attach(a,n,e,t.uiItems,t.uiKey,t.uiLinkType,t.uiDelimiter)})}}})}();