var sckApp=angular.module("ngVideoTokBox",[]);sckApp.service("ngVideoTok",["$rootScope",function(o){var i,n,a,r,e=this,s="",c={MeetingId:"",LoginName:"",LoginId:"",LognType:-1,LoginPassword:"",url:"",scope:null},d=!0;function u(e){var n=o.$$phase;"$apply"==n||"$digest"==n?e&&"function"==typeof e&&e():o.$apply(e)}function l(e){console.log(e)}function f(e,n,t){setTimeout(function(){o.$emit(e,{Status:t,Reason:n,Scope:c.scope})},500)}function t(e){setTimeout(function(){o.$emit("onstatus",{Reason:e,Scope:c.scope})},500)}var g=2,p=4,y=5,S=6,m=7,v=8,R=1,b=2,h=3,T=4,C=5,P=6,k=1,N=2,I=3,A=4,O=!1;function w(e){return n=a=r=null,d=!0,s="",t("Please wait...establishing the connection."),e&&0!==e.length?("false"!==e.ConferenceCall&&e.ConferenceCall||(e.MeetingId=function(){var e=new Date;return e.getFullYear()+n(e.getMonth()+1)+n(e.getDate())+n(e.getHours())+n(e.getMinutes())+n(e.getSeconds());function n(e){return 1===e.toLocaleString().length?"0"+e:e}}(),e.LognType=-1),e.url&&""!==e.url?e.MeetingId&&""!==e.MeetingId?e.LoginName&&""!==e.LoginName?(n=(c=e).localVideo,a=c.remoteVideo,!(!n&&!a)||(t("No video containers are defined."),!1)):(t("Enter your Name"),!1):(t("Enter a valid PIN"),!1):(t("No service url found."),!1)):(t("Required data is empty."),!1)}function L(e,n){i.connected&&i.emit(e,JSON.stringify(n))}function M(e){switch(e.Type){case"Registered":"Accepted"===e.Status?(f("connection","Registration accepted by the server.",p),d&&setTimeout(function(){$()},100)):(V(),i&&i.disconnect(),f("connection","Registration rejected by the server.",y));break;case"Answered":c=e.Answer,r.processAnswer(c,function(e){if(e)return V(),l(e)});break;case"Record":"Accepted"===e.Status?f("recording","Ready to start recording.",R):(V(),f("recording","Recording rejected by the server.",b));break;case"StartRecord":"Accepted"===(o=e).Status?(s=o.FileName,f("recording","Recording...",h)):(V(),f("recording","Recording rejected by the server.",T));break;case"StopRecord":!function(e){V(),i&&i.disconnect();"Accepted"===e.Status?(s=e.FileName,f("recording","Recording stopped...",C)):f("recording","Recording rejected by the server.",P)}(e);break;case"StartPlay":"Accepted"===(t=e).Status?(f("playing","Playing...",k),s=t.FileName,L("startplay",{})):(V(),f("playing","Playing rejected by the server.",N));break;case"StopPlay":!function(e){V(),i&&i.disconnect();"Accepted"===e.Status?f("playing","Playing stopped...",I):f("playing","Playing rejected by the server.",A)}(e);break;case"CallStatus":"Waiting"===(n=e).Status?f("call",n.Reason+"...",S):"IncomingCall"===n.Status?(f("call",n.Reason+"...",S),O?setTimeout(function(){$()},100):L("call",{Status:"START"})):"CallAccepted"===n.Status?f("call",n.Reason+"...",m):"CallDropped"===n.Status&&(a.src="#",O=!0,f("call",n.Reason+"...",v));break;case"OnIceCandidate":r.addIceCandidate(e.Candidate);break;case"ForceDisconnect":f("connection",null,22);break;case"PONG":setTimeout(function(){L({Type:"PING"})},800)}var n,t,o,c}function V(){r&&(r.dispose(),r=null)}function $(){if(!i||!i.connected)return f("connection","You are disconnected from the server.",g);t("Initializing...");var e={localVideo:n,remoteVideo:a};"false"!==c.ConferenceCall&&c.ConferenceCall||(e={localVideo:n}),r=kurentoUtils.WebRtcPeer.WebRtcPeerSendrecv(e,function(e){if(e)return V(),l(e);this.generateOffer(function(e,n){if(e)return V(),l(e);r.on("icecandidate",function(e){L("icecandidate",{Candidate:e})}),O?(O=!1,L("call",{Status:"RESTART",SdpOffer:n})):L("openwebtrc",{sdpOffer:n})})})}function f(n,t,o){setTimeout(function(){var e=F[n];e&&u(function(){e({Status:o,Reason:t})})},500)}var F={};e.validate=function(e){return w(e)},e.connect=function(){O=!1,(i=io.connect(c.url))&&(i.on("connect",function(){f("connection","You are connected to the server.",1)}),i.on("disconnect",function(){V(),f("connection","You are disconnected from the server.",g)}),i.on("connect_error",function(){V(),i.disconnect(),f("connection","Error in connection establishment.",3)}),i.on("messages",function(e){M(JSON.parse(e))}))},e.disconnect=function(e){if(i)if(i.disconnected)i.emit("disconnect");else{var n=0;e&&e.typeOfDisconnect&&(L("forcedisconnect",{Reason:e.typeOfDisconnect}),n=100),setTimeout(function(){i.disconnect()},n)}},e.setFileName=function(e){s=e},e.getFileName=function(){return s},e.audiotogglelicked=function(e){r&&(r.audioEnabled=e)},e.videotoggleclicked=function(e){r&&(r.videoEnabled=e)},e.playrecord=function(e){e?(t("Please wait stopping the play..."),L("play",{Status:"STOP"})):(t("Please wait starting the play..."),function(){if(!i||!i.connected)return f("connection","You are disconnected from the server.",g);t("Initializing...");var e={remoteVideo:n};r=kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(e,function(e){if(e)return V(),l(e);this.generateOffer(function(e,n){if(e)return V(),l(e);r.on("icecandidate",function(e){L("icecandidate",{Candidate:e})}),L("play",{sdpOffer:n,Status:"START",filename:s})})})}())},e.startrecord=function(e){var n={Status:"START"};e?(t("Please wait stopping the recording..."),n={Status:"STOP"}):t("Please wait starting the recording..."),L("record",n)},e.register=function(e){d=e,t("Initializing..."),L("register",{MeetingId:c.MeetingId,UserId:c.LoginId,Name:c.LoginName,Type:c.LognType,ConferenceCall:c.ConferenceCall})},e.on=function(e,n){F[e]&&delete F[e],F[e]=n},e.emit=function(e,n,t){var o=arguments;i?i.emit(e,n,function(){u(function(){t&&t.apply(i,o)})}):u(function(){t.apply(i,o)})}}]);